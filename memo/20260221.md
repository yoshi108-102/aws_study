今日はS3をTerraformを作ってみることにした

とりあえずChatGPTの言う通りに`main.tf`を作成の上、

```bash
terraform init
terraform fmt
terraform validate
terraform plan
terraform apply
```
としたところ、自分のAWS上にS3バケットが作成された。

https://aws.amazon.com/jp/s3/

S3の説明はここに書いてある。
どうやら10GBあたり東京リージョンだと25円とかで使えるクラウドストレージであるようだ

```json
terraform {
  required_version = ">= 1.5.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = ">= 3.5"
    }
  }
}
```
とか書いてあるので、まあAWSのプラグイン的な何かと、` bucket = "tf-s3-try-${random_id.suffix.hex}"`をやるための乱数生成器を定義しているのかな

hexは16進数のことで、bite_lengthが4だから32ビットの16進数なので、8文字のランダムな文字列を生成する感じ？

あとは公開ブロックとかを設定している。これは事故防止のためらしい

もう一個作ってみるかと思ったが、2個めは何故か生成されず

```bash
>> terraform plan
No changes. Your infrastructure matches the configuration.
```
と出てくるので、S3 createとS3 updateは全く同じtfファイルでいいらしい
n回実行したらn個のS3が作られるわけではないのね

`terraform.tfstate`というファイルが作られて、これに状態が保存されるらしい

```bash
>> terraform output
bucket_name = "tf-s3-try-f985274f"
```
壊したくなったら `terraform destroy` を実行

試しにdata/ ディレクトリにあるfileを全てuploadできるようにしてみる
tfを変えてみたが、terraform planをしても何も変わらなかった

```bash
terraform console
```
terraform consoleで試してみると、
```bash
>> fileset("${path.module}/memo", "**/*.md")
toset([])
```
なんか空っぽ
普通にディレクトリの位置が違っていたので変更したところ
```bash
>> fileset("${path.module}/../memo", "**/*.md")
toset(["20260221.md"])
```
できた
```bash
> terraform apply
Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
```

AWSコンソールで確認すると、確かにmemo/の下に20260221.mdが作られた


ライフサイクルとバージョン管理をつけた

```bash
>BUCKET=tf-s3-try-4e7e8854
>aws s3api get-bucket-lifecycle-configuration --bucket "$BUCKET"

{
    "TransitionDefaultMinimumObjectSize": "all_storage_classes_128K",
    "Rules": [
        {
            "ID": "expire-noncurrent-versions",
            "Filter": {},
            "Status": "Enabled",
            "NoncurrentVersionExpiration": {
                "NoncurrentDays": 30
            }
        }
    ]
}
```

```json
terraform {
  required_version = ">= 1.5.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = ">= 3.5"
    }
  }
}
```
```json
output "bucket_name" {
  value = aws_s3_bucket.this.bucket
}
```
outputの値は共有の値なのでmoduleの外から参照できるので、関数みたいに別のモジュールに値を公開するのにも使う感じ
親子関係のモジュール間で値を共有するのにも使える

静的サイトをS3に上げてみる。
まあすぐ消すしいいかなと思って、S3の公開ブロックは全部解除してしまった。
あと、静的Webで特に機密情報は置いてないからいいかみたいな
いったんcloudfrontは使わずにS3のURLでアクセスできるようにした。

curlとかで認証なしに全て取得可能な上、暗号化もされていないので、
まあこのままでは危険な状態ではあるが、機密とかは特に入っていない。

S3を見ると、さっきdestroyしたsandboxもしっかりなくなっていて、
新たにwebsite用のS3が見えているからよし！


次はcloudfrontを導入して、httpsでアクセスできるようにする。

そういえば自分はnotionでleetcodeのメモを管理しているが、アルゴリズムの可視化みたいなのをhtmlでして、S3で管理したりしても面白そう